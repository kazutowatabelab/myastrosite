---
// 1行目にこれが必要です！
import BlogPost from './BlogPost.astro';

const { content, lang = 'en', ...props } = Astro.props;

const isEn = lang === 'en';

// 前回の currentSlug 定義も忘れずに
const currentSlug = content?.id || props.id || ''; 

const title = isEn 
  ? (content?.title_en || content?.title || props.title || "Untitled") 
  : (content?.title || props.title || "無題");

const pubDate = content?.publishedAt || props.pubDate;
const heroImage = content?.eyecatch?.url || props.heroImage;

// HTMLからテキストを抽出する関数（100文字程度）
function extractTextFromHtml(html: string, maxLength: number = 100): string {
  if (!html) return '';
  
  // HTMLタグを除去
  let text = html.replace(/<[^>]*>/g, '');
  // 改行や連続する空白を整理
  text = text.replace(/\s+/g, ' ').trim();
  // 指定文字数で切り取り
  if (text.length > maxLength) {
    text = text.substring(0, maxLength);
    // 最後の単語が途中で切れないように調整
    const lastSpace = text.lastIndexOf(' ');
    if (lastSpace > maxLength * 0.7) {
      text = text.substring(0, lastSpace);
    }
    text += '...';
  }
  return text;
}

// 説明文の生成（優先順位: descriptionフィールド > 本文から抽出）
const rawDescription = isEn 
  ? (content?.description_en || content?.description || '')
  : (content?.description || '');

const rawContent = isEn 
  ? (content?.content_en || content?.content || '')
  : (content?.content || '');

// 説明文フィールドがあればそれを使い、なければ本文から抽出
const description = rawDescription 
  ? (rawDescription.length > 100 ? rawDescription.substring(0, 100) + '...' : rawDescription)
  : extractTextFromHtml(rawContent, 100);

const jpPath = `/blog/jp/${currentSlug}`;
const enPath = `/blog/en/${currentSlug}`;
---

<BlogPost title={title} description={description} pubDate={pubDate} heroImage={heroImage} lang={isEn ? 'en' : 'ja'} {...props}>
  <div class="lang-switch">
    <a href={jpPath} class={lang === 'jp' ? 'active' : ''}>日本語</a>
    <span>/</span>
    <a href={enPath} class={lang === 'en' ? 'active' : ''}>English</a>
  </div>
  
  <slot />
</BlogPost>

<style>
  .lang-switch {
    text-align: right;
    margin-bottom: 2rem;
    font-size: 0.9rem;
  }
  .lang-switch a {
    text-decoration: none;
    color: #888;
  }
  .lang-switch a.active {
    font-weight: bold;
    color: #000;
    text-decoration: underline;
  }

  :global(.hero-image) {
    width: 100% !important;
    max-width: none !important;
    display: flex !important;
    justify-content: flex-start !important;
    margin: 0 0 2rem 0 !important;
  }

  :global(.hero-image img) {
    max-width: 600px !important;
    width: 100% !important;
    height: auto !important;
    margin-left: 0 !important;
    margin-right: auto !important;
    border-radius: 8px;
    object-fit: contain !important;
  }
</style>